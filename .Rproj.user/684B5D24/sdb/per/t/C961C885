{
    "collab_server" : "",
    "contents" : "#-----------------------------------------------------------------------------------#\n# Haggard et al. \"Using a high-throughput steroidogenesis assay to predict effects on \n# ...estrogen and androgen production or overall perturbation of the steroid biosynthesis pathway\"\n\n# Supp 7 ANOVA-anbnotated concentration response and Mahalanobis distance plots\n\n# This code generates the figures in Supp. 7\n\n#updated 08/11/2017\n\nrm(list = ls())\n\nlibrary(reshape2)\nlibrary(grid)\nlibrary(gridExtra)\nlibrary(ggplot2)\nlibrary(GGally)\nlibrary(stringr)\nlibrary(data.table)\nlibrary(ggthemes)\nlibrary(dplyr)\nlibrary(ggplot2)\nlibrary(ggthemes)\nlibrary(RColorBrewer)\nlibrary(ggiraphExtra)\nlibrary(corrplot)\nlibrary(cowplot)\nlibrary(ComplexHeatmap)\nlibrary(circlize)\nlibrary(raster)\n\nsetwd(\"../Mahalanobis Distance\")\n\n#-------------------------------------------------------------------------------------------------#\n#-----Load in all of the data from the mahalanobis_script.R output RData file\n#-------------------------------------------------------------------------------------------------#\n\nload(\"../RData/AllResps2017-08-09.RData\")\nload(\"../RData/Global_ANOVA_2017-08-09.RData\")\n\n#-------------------------------------------------------------------------------------------------#\n#-----Add critical limits to Dists from Mahalanobis_dat\n#-------------------------------------------------------------------------------------------------#\n\ncolnames(Dists)[4] <- \"date_chnm_plate\"\n\nDists[, date_chnm_plate := as.character(date_chnm_plate)]\n\nfor(x in unique(Dists$date_chnm_plate)){\n  Dists[date_chnm_plate == x, c(\"Scrit05\", \"Scrit01\") := .(Mahalanobis_dat[date_chnm_plate == x, Scrit05], Mahalanobis_dat[date_chnm_plate == x, Scrit01])]\n}\n\n#-------------------------------------------------------------------------------------------------#\n#-----combine dat_mean and Dists\n#-------------------------------------------------------------------------------------------------#\n\ndat <- dat[, c(2,3, 15:19, 9:10, 6:8, 14)]\ndat_wide <- dcast.data.table(dat, ... ~ steroid, value.var = \"uM\")\ndat_wide[, c(\"D11P\", \"Scrit05\", \"Scrit01\") := 0]\n\ndat_wide_DMSO <- dat_wide[chnm == \"DMSO\",]\ndat_wide_chems <- dat_wide[chnm != \"DMSO\",]\n\nfor(x in unique(dat_wide_chems[, date_chnm_plate])){\n  for(y in unique(dat_wide_chems[date_chnm_plate == x, conc])){\n    dat_wide_chems[date_chnm_plate == x & conc == y, c(\"D11P\", \"Scrit05\", \"Scrit01\") := .(Dists[date_chnm_plate == x & Conc == y, D11P],\n                                                                                          Dists[date_chnm_plate == x & Conc == y, Scrit05],\n                                                                                          Dists[date_chnm_plate == x & Conc == y, Scrit01])]\n  }\n}\n\ndat_combined_wide <- rbind(dat_wide_chems, dat_wide_DMSO)\n\n#-------------------------------------------------------------------------------------------------#\n#-----Housekeeping: look at the number of chemicals with missing concs due to viability or NR\n#-------------------------------------------------------------------------------------------------#\n\nconc_counter <- dat_combined_wide[chnm != \"DMSO\", .(date_chnm_plate = date_chnm_plate, N = length(unique(conc))), by = \"date_chnm_plate\"]\nconc_counter[N == 0, .N]#0\nconc_counter[N == 1, .N]#0\nconc_counter[N == 2, .N]#4 \nconc_counter[N == 3, .N]#5\nconc_counter[N == 4, .N]#6\nconc_counter[N == 5, .N]#36\nconc_counter[N == 6, .N]#715\n\n#-------------------------------------------------------------------------------------------------#\n#-----Convert to long format for plotting\n#-------------------------------------------------------------------------------------------------#\n\ndat_combined <- melt.data.table(dat_combined_wide, id.vars = colnames(dat_combined_wide)[c(1:11, 24:25)], value.name = \"Value\", variable.name = \"Measurement\")\n\n#-------------------------------------------------------------------------------------------------#\n#-------drop the NAs which show up due to NR values in the raw data\n#-------------------------------------------------------------------------------------------------#\n\ndat_combined <- dat_combined[!is.na(Value),]\n\n#-------------------------------------------------------------------------------------------------#\n#-----Fix the levels of the Measurement factors\n#-------------------------------------------------------------------------------------------------#\n\ndat_combined[Measurement == \"D11P\", Measurement := \"Mahalanobis Distance\",]\n\n#-------------------------------------------------------------------------------------------------#\n#-----Fix Measurement labels\n#-------------------------------------------------------------------------------------------------#\n\ndat_combined[Measurement == \"OH-Progesterone\", Measurement := \"OHPROG\"]\ndat_combined[Measurement == \"OH-Pregnenolone\", Measurement := \"OHPREG\"]\ndat_combined[Measurement == \"Progesterone\", Measurement := \"PROG\"]\ndat_combined[Measurement == \"Pregnenolone\", Measurement := \"PREG\"]\ndat_combined[Measurement == \"Androstenedione\", Measurement := \"ANDR\"]\ndat_combined[Measurement == \"11-deoxycortisol\", Measurement := \"11DCORT\"]\ndat_combined[Measurement == \"Testosterone\", Measurement := \"TESTO\"]\ndat_combined[Measurement == \"Corticosterone\", Measurement := \"CORTIC\"]\ndat_combined[Measurement == \"Estrone\", Measurement := \"ESTRONE\"]\ndat_combined[Measurement == \"Estradiol\", Measurement := \"ESTRADIOL\"]\ndat_combined[Measurement == \"Cortisol\", Measurement := \"CORTISOL\"]\n\ndat_combined[, Measurement := factor(Measurement, levels = c(\"OHPREG\", \"PROG\", \"OHPROG\",\n                                                             \"DOC\", \"CORTIC\", \"11DCORT\", \"CORTISOL\",\n                                                             \"ANDR\", \"TESTO\", \"ESTRONE\", \"ESTRADIOL\", \"Mahalanobis Distance\"))]\n\nANOVA_summary_out_long[steroid == \"OH-Progesterone\", steroid := \"OHPROG\"]\nANOVA_summary_out_long[steroid == \"OH-Pregnenolone\", steroid := \"OHPREG\"]\nANOVA_summary_out_long[steroid == \"Progesterone\", steroid := \"PROG\"]\nANOVA_summary_out_long[steroid == \"Pregnenolone\", steroid := \"PREG\"]\nANOVA_summary_out_long[steroid == \"Androstenedione\", steroid := \"ANDR\"]\nANOVA_summary_out_long[steroid == \"11-deoxycortisol\", steroid := \"11DCORT\"]\nANOVA_summary_out_long[steroid == \"Testosterone\", steroid := \"TESTO\"]\nANOVA_summary_out_long[steroid == \"Corticosterone\", steroid := \"CORTIC\"]\nANOVA_summary_out_long[steroid == \"Estrone\", steroid := \"ESTRONE\"]\nANOVA_summary_out_long[steroid == \"Estradiol\", steroid := \"ESTRADIOL\"]\nANOVA_summary_out_long[steroid == \"Cortisol\", steroid := \"CORTISOL\"]\n\n#-------------------------------------------------------------------------------------------------#\n#-----Clean up ANOVA table\n#-------------------------------------------------------------------------------------------------#\n\nANOVA_summary_out_long[, date_chnm_plate := str_replace(date_chnm_plate, \"PharmaGSID_\", \"PharmaGSID\")]\nANOVA_summary_out_long[conc >= 99.9, conc := 100]\nANOVA_summary_out_long[str_detect(date_chnm_plate,\"Triclosan\") & conc == 0.004115226, conc := 0.004] \n\nANOVA_summary_out_long[, conc := signif(conc, digits = 2)]\n\n#-------------------------------------------------------------------------------------------------#\n#-----Add p-value information to dat0_combined to annotate significant effects in plots\n#-------------------------------------------------------------------------------------------------#\n\nANOVA_summary_out_long[is.na(PValue), PValue := 2]\n\ndat_combined[, Pvalue := 1]\n\n\nfor(x in unique(dat_combined[chnm != \"DMSO\", date_chnm_plate])){\n  for(z in unique(dat_combined[date_chnm_plate == x & Measurement != \"Mahalanobis Distance\", Measurement])){\n    for(y in unique(dat_combined[date_chnm_plate == x & Measurement == z & chnm != \"DMSO\", conc])){\n      dat_combined[date_chnm_plate == x & conc == y & Measurement == z, Pvalue := ANOVA_summary_out_long[date_chnm_plate == x & conc == y & steroid == z, PValue]]\n    }\n  }\n}\n\ndat_combined <- dat_combined[Pvalue != 2,]\n\ndat_combined[, sig := factor(ifelse(Pvalue <= 0.05, 1, 0))]\ndat_combined[,conc_index := factor(conc_index, levels = c(\"CONC6\", \"CONC5\", \"CONC4\", \"CONC3\", \"CONC2\", \"CONC1\"))]\n\n#-------------------------------------------------------------------------------------------------#\n#-----Generate Supp 7 file (ANOVA plots with mMD plot as well)\n#-------------------------------------------------------------------------------------------------#\n\npdf(paste0(\"Supp7_OECD_global_concResp_mMD_\", Sys.Date(), \".pdf\"), width = 12, height = 8)\nfor(x in unique(dat_combined[chnm != \"DMSO\", date_chnm_plate])){\n  p <- vector(\"list\", 12)\n  plotting_dat <- dat_combined[date_chnm_plate == x]\n  con <- paste(unique(plotting_dat[, date]), \"DMSO\", unique(plotting_dat[, plate]), sep = \"_\")\n  plotting_dat <- dat_combined[date_chnm_plate == x | date_chnm_plate == con,]\n  i <- 1\n  for(y in unique(levels(plotting_dat[, Measurement]))){\n    plot_dat <- plotting_dat[Measurement == y]\n    plot_dat[, Fconc := factor(conc)]\n    if(unique(plot_dat[, Measurement]) != \"Mahalanobis Distance\"){\n      ft <- lm(Value ~ Fconc, data = plot_dat[Measurement != \"Mahalanobis Distance\"])\n      pdta <- unique(plot_dat[,c(\"conc\", \"Fconc\"), with = FALSE])\n      pdta$mn <- predict(ft, newdata=pdta)\n    }\n    if(unique(plot_dat[, Measurement]) != \"Mahalanobis Distance\"){\n      conc_resp_plot <- ggplot(data = plot_dat, aes(x = conc, y = (Value))) +\n        geom_point(aes(color = sig)) +\n        geom_point(data = pdta, aes(x = conc, y = (mn)), shape = 3) +\n        geom_hline(yintercept = (1.5*mean(plot_dat[conc == 0, Value])), linetype = \"dashed\") +\n        geom_hline(yintercept = (1/1.5*mean(plot_dat[conc == 0, Value])), linetype = \"dashed\") +\n        ggtitle(label = y) +\n        scale_x_log10(\"\") +\n        scale_color_manual(values = c(\"black\", \"red\"), guide = FALSE) +\n        ylab(\"\") +\n        theme_few()\n      p[[i]] <- conc_resp_plot\n    } else {\n      conc_resp_plot <- ggplot(data = plot_dat[chnm != \"DMSO\",], aes(x = conc, y = Value)) +\n        geom_point() +\n        geom_hline(yintercept = unique(plot_dat[chnm != \"DMSO\", Scrit01]), linetype = \"dashed\", color = \"red\") +\n        #geom_hline(yintercept = unique(plot_dat[chnm != \"DMSO\", Scrit05]), linetype = \"dashed\", color = \"blue\") +\n        ggtitle(label = y) +\n        scale_x_log10(\"\") +\n        ylab(\"Distance\") +\n        theme_few()\n      p[[i]] <- conc_resp_plot\n    }\n    i <- i +1\n  }\n  grid.arrange(grobs = p, #layout_matrix=layout,\n               top = textGrob(x, gp=gpar(fontsize=16)),\n               bottom=textGrob(\"Concentration (uM)\", gp=gpar(fontsize=16)),\n               left=textGrob(\"Measured Analyte (uM)\", gp=gpar(fontsize=16), rot=90))\n  #break\n}\ndev.off()\n\n#-------------------------------------------------------------------------------------------------#\n#-----Generate fold-change of H295R response data relative to plate-wise DMSO samples\n#-------------------------------------------------------------------------------------------------#\n\ndmso_block_average <- dat_combined[chnm == \"DMSO\", .(plate_dmso = mean(Value)), by = .(Measurement, date_chnm_plate)]\n\ndmso_block_average <- dmso_block_average[Measurement != \"Mahalanobis Distance\",]\ndmso_block_average[, date_plate := str_replace(date_chnm_plate, \"_DMSO_\", \"_\")]\n\ndat_radar <- copy(dat_combined)\n\ndat_radar[, date_plate := paste(date, plate, sep = \"_\")]\n\nfor(x in unique(as.character(dat_radar[Measurement != \"Mahalanobis Distance\", Measurement]))){\n  for(block in unique(dat_radar[chnm != \"DMSO\", date_plate])){\n    for(y in unique(dat_radar[date_plate == block, date_chnm_plate]))\n      dat_radar[Measurement == x & date_plate == block & date_chnm_plate == y, fold_change := Value/dmso_block_average[Measurement == x & date_plate == block, plate_dmso]]\n  }\n}\n\ndat_radar[, log_fold_change := log2(fold_change)]\n#dat_radar[, log_fold_change := log10(fold_change)]\n\ndat_radar_wide <- dcast.data.table(dat_radar[Measurement != \"Mahalanobis Distance\", c(1:7, 10:11, 14, 20)], ... ~ Measurement,\n                                   value.var = c(\"log_fold_change\"), fun.aggregate = mean) #convert to wide format\n\n#-------------------------------------------------------------------------------------------------#\n#-----Generate Supp 8 file (Radar plots and maxmMd plot)\n#-------------------------------------------------------------------------------------------------#\npdf(paste0(\"Supp8_OECD_GLOBAL_radar_mDist_plots_\", Sys.Date(), \".pdf\"), width = 16, height = 10)\nfor(x in unique(dat_combined[chnm != \"DMSO\", date_chnm_plate])){\n  p <- vector(\"list\", 2)\n  \n  radar_dat <- dat_radar[date_chnm_plate == x & Measurement != \"Mahalanobis Distance\"]\n  con <- paste(unique(radar_dat[, date]), \"DMSO\", unique(radar_dat[, plate]), sep = \"_\")\n  radar_dat <- dat_radar[date_chnm_plate == x & Measurement != \"Mahalanobis Distance\" | date_chnm_plate == con & Measurement != \"Mahalanobis Distance\",]\n  radar_dat[, conc := factor(conc)]\n  \n  lims <- c(min(radar_dat[,log_fold_change]) - 0.5, max(radar_dat[, log_fold_change]) + 0.5)\n  \n  radar_dat <- dcast.data.table(radar_dat[Measurement != \"Mahalanobis Distance\", c(1:7, 10:11, 14, 20)], ... ~ Measurement,\n                                value.var = c(\"log_fold_change\"), fun.aggregate = mean) #convert to wide format\n  \n  radar <- ggRadar(data = radar_dat[, -c(1:7)], aes(col = conc), rescale = FALSE, legend = \"right\", alpha = 0) +\n    geom_hline(yintercept = c(log2(1.5), log2(1/1.5)), linetype = \"dashed\", color = \"red\") +\n    coord_polar() +\n    scale_color_brewer(palette = \"YlGnBu\") +\n    ylim(lims) +\n    theme_minimal()\n  \n  p[[1]] <- radar\n  \n  mMD_dat <- dat_combined[date_chnm_plate == x,]\n  con <- paste(unique(mMD_dat[, date]), \"DMSO\", unique(mMD_dat[, plate]), sep = \"_\")\n  mMD_dat <- dat_combined[date_chnm_plate == x & Measurement == \"Mahalanobis Distance\" | date_chnm_plate == con & Measurement == \"Mahalanobis Distance\",]\n  \n  mMD <- ggplot(data = mMD_dat[chnm != \"DMSO\",], aes(x = conc, y = Value)) +\n    geom_point() +\n    geom_hline(yintercept = unique(mMD_dat[chnm != \"DMSO\", Scrit01]), linetype = \"dashed\", color = \"red\") +\n    ggtitle(label = \"Mahalanobis Distance\") +\n    scale_x_log10(\"Concentration (uM)\") +\n    ylab(\"Distance\") +\n    theme_few()\n  \n  p[[2]] <- mMD\n  \n  lay <- rbind(c(1, 1, NA), c(1, 1, 2), c(1, 1, 2), c(1, 1, NA))\n  \n  grid.arrange(grobs = p, layout_matrix = lay,\n               top = textGrob(x, gp=gpar(fontsize=16)))\n}\ndev.off()\n",
    "created" : 1504106428460.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2152410006",
    "id" : "C961C885",
    "lastKnownWriteTime" : 1502719625,
    "last_content_update" : 1502719625,
    "path" : "L:/Lab/NCCT_ToxCast/Derik Haggard/OECD Analysis/R Scripts for Pub/Scripts/Supp7_and Supp8_ANOVA_concResp_and_radar_plots.R",
    "project_path" : "Scripts/Supp7_and Supp8_ANOVA_concResp_and_radar_plots.R",
    "properties" : {
    },
    "relative_order" : 3,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}